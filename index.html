<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donation Page</title>
    <!-- Pico CSS for minimalistic styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <!-- Favicon placeholder to avoid 404 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∏</text></svg>">
    <style>
        body {
            background: #f5f5f5;
            font-size: 1rem;
        }
        .page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .container {
            max-width: 32rem;
            width: 100%;
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            font-size: 1.6rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        h2 {
            font-size: 1.2rem;
            text-align: center;
            margin: 1.5rem 0 1rem;
        }
        input, textarea, button {
            margin-bottom: 0.75rem;
        }
        .overlay-alert {
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            max-width: 32rem;
            width: 100%;
            text-align: center;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
        .fade-in { animation: fadeIn 1s ease-in-out; }
        .fade-out { animation: fadeOut 1s ease-in-out; }
        .hidden { display: none; }
        table {
            width: 100%;
            font-size: 0.85rem;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #e5e7eb;
        }
        @media (max-width: 600px) {
            .container { padding: 1rem; }
            table { font-size: 0.75rem; }
            th, td { padding: 0.3rem; }
        }
    </style>
</head>
<body>
    <!-- Main Donation Page -->
    <div id="main-page" class="page">
        <div class="container">
            <h1>–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∞–≤—Ç–æ—Ä–∞</h1>
            <form>
                <input id="nickname" type="text" placeholder="–í–∞—à –Ω–∏–∫" maxlength="20" required aria-label="–ù–∏–∫–Ω–µ–π–º">
                <input id="amount" type="number" placeholder="–°—É–º–º–∞ (RUB)" min="1" step="0.01" required aria-label="–°—É–º–º–∞">
                <textarea id="message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ (–¥–æ 180 —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="180" rows="4" required aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
                <button id="donate-btn" type="button" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="page hidden">
        <div class="container">
            <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <form>
                <input id="shop-id" type="text" placeholder="Shop ID" required aria-label="Shop ID">
                <input id="secret-key" type="password" placeholder="Secret Key" required aria-label="Secret Key">
                <button id="save-settings" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="back-to-main" type="button">–ù–∞–∑–∞–¥</button>
            </form>
            <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–Ω–∞—Ç—ã</h2>
            <table id="donations-table">
                <thead>
                    <tr>
                        <th>–í—Ä–µ–º—è</th>
                        <th>–ù–∏–∫</th>
                        <th>–°—É–º–º–∞ (RUB)</th>
                        <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="donations-table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Overlay Page -->
    <div id="overlay-page" class="page hidden" style="background: transparent;">
        <div id="donation-alert" class="overlay-alert hidden">
            <p id="overlay-nickname" style="font-size: 1.3rem; font-weight: bold;"></p>
            <p id="overlay-amount" style="font-size: 1.1rem;"></p>
            <p id="overlay-message" style="font-size: 0.85rem; margin-top: 0.5rem;"></p>
        </div>
    </div>

    <script>
        // State
        let settings = JSON.parse(localStorage.getItem('donation-settings')) || { shopId: '', secretKey: '' };
        let donations = JSON.parse(localStorage.getItem('donations')) || [];

        // DOM
        const mainPage = document.getElementById('main-page');
        const adminPanel = document.getElementById('admin-panel');
        const overlayPage = document.getElementById('overlay-page');
        const donateBtn = document.getElementById('donate-btn');
        const nicknameInput = document.getElementById('nickname');
        const amountInput = document.getElementById('amount');
        const messageInput = document.getElementById('message');
        const shopIdInput = document.getElementById('shop-id');
        const secretKeyInput = document.getElementById('secret-key');
        const saveSettingsBtn = document.getElementById('save-settings');
        const backToMainBtn = document.getElementById('back-to-main');
        const donationAlert = document.getElementById('donation-alert');
        const overlayNickname = document.getElementById('overlay-nickname');
        const overlayAmount = document.getElementById('overlay-amount');
        const overlayMessage = document.getElementById('overlay-message');
        const donationsTableBody = document.getElementById('donations-table-body');

        // Log Helper
        const log = (msg, data) => console.log(msg, data);

        // Update Donations Table
        function updateDonationsTable() {
            donationsTableBody.innerHTML = '';
            donations.slice(-10).reverse().forEach(donation => {
                const row = document.createElement('tr');
                const date = new Date(donation.timestamp).toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' });
                row.innerHTML = `<td>${date}</td><td>${donation.nickname}</td><td>${donation.amount.toFixed(2)}</td><td>${donation.message}</td>`;
                donationsTableBody.appendChild(row);
            });
            log('Donations table updated:', donations.slice(-10));
        }

        // Update Donate Button
        function updateDonateButton() {
            const hasSettings = settings.shopId && settings.secretKey;
            const hasInputs = nicknameInput.value.trim() && amountInput.value > 0 && messageInput.value.trim();
            log('Settings:', { shopId: settings.shopId, secretKey: settings.secretKey ? '[hidden]' : '' });
            log('Inputs:', {
                nickname: nicknameInput.value.trim(),
                amount: amountInput.value,
                message: messageInput.value.trim(),
                valid: hasInputs
            });
            donateBtn.disabled = !hasSettings || !hasInputs;
        }

        // Event Listeners
        nicknameInput.addEventListener('input', updateDonateButton);
        amountInput.addEventListener('input', updateDonateButton);
        messageInput.addEventListener('input', updateDonateButton);

        // Initialize
        shopIdInput.value = settings.shopId;
        secretKeyInput.value = settings.secretKey;
        log('Initial localStorage:', {
            settings: localStorage.getItem('donation-settings'),
            donations: localStorage.getItem('donations')
        });
        updateDonateButton();
        updateDonationsTable();

        // Save Settings
        saveSettingsBtn.addEventListener('click', () => {
            settings = { shopId: shopIdInput.value.trim(), secretKey: secretKeyInput.value.trim() };
            localStorage.setItem('donation-settings', JSON.stringify(settings));
            log('Settings saved:', { shopId: settings.shopId, secretKey: '[hidden]' });
            alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            updateDonateButton();
        });

        // Navigation
        backToMainBtn.addEventListener('click', () => {
            adminPanel.classList.add('hidden');
            mainPage.classList.remove('hidden');
            log('Navigated back to main page', {});
        });

        // Admin Panel Access
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && e.key === 'a') {
                const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:');
                if (password === 'admin123') {
                    mainPage.classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                    updateDonationsTable();
                    log('Admin panel accessed', {});
                } else {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
                    log('Admin access denied: incorrect password', {});
                }
            }
        });

        // Donation Handler (Mock Payment)
        donateBtn.addEventListener('click', () => {
            log('Donate button clicked', {});
            const amount = parseFloat(amountInput.value);
            const nickname = nicknameInput.value.trim();
            const message = messageInput.value.trim();
            log('Donation data:', { nickname, amount, message });

            try {
                const donation = {
                    id: `mock-${Date.now()}`,
                    nickname,
                    amount,
                    message,
                    timestamp: Date.now(),
                    shown: false
                };
                donations.push(donation);
                localStorage.setItem('donations', JSON.stringify(donations));
                log('Donation saved:', donation);
                log('Current donations:', donations);

                nicknameInput.value = '';
                amountInput.value = '';
                messageInput.value = '';
                updateDonateButton();
                updateDonationsTable();
                log('Form cleared and table updated', {});

                alert('–ü–ª–∞—Ç–µ–∂ –∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ! –î–æ–Ω–∞—Ç –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –≤ –æ–≤–µ—Ä–ª–µ–µ.');
            } catch (error) {
                log('Payment error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–æ–Ω–∞—Ç–∞: ' + error.message);
            }
        });

        // Overlay Logic
        function checkForNewDonations() {
            log('Checking for new donations:', donations.length);
            const lastDonation = donations[donations.length - 1];
            if (lastDonation && !lastDonation.shown) {
                log('Displaying donation:', lastDonation);
                overlayNickname.textContent = lastDonation.nickname;
                overlayAmount.textContent = `${lastDonation.amount.toFixed(2)} RUB`;
                overlayMessage.textContent = lastDonation.message;

                donationAlert.classList.remove('hidden');
                donationAlert.classList.add('fade-in');

                setTimeout(() => {
                    donationAlert.classList.remove('fade-in');
                    donationAlert.classList.add('fade-out');
                    setTimeout(() => {
                        donationAlert.classList.add('hidden');
                        donationAlert.classList.remove('fade-out');
                        lastDonation.shown = true;
                        localStorage.setItem('donations', JSON.stringify(donations));
                        log('Donation marked as shown:', lastDonation);
                    }, 1000);
                }, 15000);
            }
        }

        // Overlay Page Load
        if (window.location.hash === '#overlay') {
            mainPage.classList.add('hidden');
            adminPanel.classList.add('hidden');
            overlayPage.classList.remove('hidden');
            log('Overlay page loaded', {});
            setInterval(checkForNewDonations, 1000);
        }
    </script>
</body>
</html>
