<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donation Page</title>
    <!-- Pico CSS for lightweight, modern styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <!-- YooKassa SDK (included for potential future use) -->
    <script src="https://yookassa.ru/checkout-widget/v1/checkout-widget.js"></script>
    <style>
        /* Custom styles for minimalism and animations */
        body {
            background: #f5f5f5;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        .page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
        .container {
            max-width: 36rem;
            width: 100%;
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            font-size: 1.8rem;
            color: #1a1a1a;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        h2 {
            font-size: 1.4rem;
            margin-top: 2rem;
            text-align: center;
        }
        input, textarea, button {
            margin-bottom: 1rem;
        }
        button {
            transition: background-color 0.3s ease;
        }
        .overlay-alert {
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            max-width: 36rem;
            width: 100%;
            text-align: center;
            font-size: 1rem;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
        .fade-in {
            animation: fadeIn 1s ease-in-out;
        }
        .fade-out {
            animation: fadeOut 1s ease-in-out;
        }
        .hidden {
            display: none;
        }
        table {
            width: 100%;
            margin-top: 1rem;
            font-size: 0.9rem;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
        }
        th {
            background: #e5e7eb;
            font-weight: 600;
        }
        td {
            border-bottom: 1px solid #e5e7eb;
        }
        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }
            table {
                font-size: 0.8rem;
            }
            th, td {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Main Donation Page -->
    <div id="main-page" class="page">
        <div class="container">
            <h1>Поддержать автора</h1>
            <form>
                <input id="nickname" type="text" placeholder="Ваш ник" maxlength="20" required aria-label="Никнейм">
                <input id="amount" type="number" placeholder="Сумма (RUB)" min="1" step="0.01" required aria-label="Сумма">
                <textarea id="message" placeholder="Сообщение (до 180 символов)" maxlength="180" rows="4" required aria-label="Сообщение"></textarea>
                <button id="donate-btn" type="button" disabled>Отправить</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="page hidden">
        <div class="container">
            <h1>Админ-панель</h1>
            <form>
                <input id="shop-id" type="text" placeholder="Shop ID (YooKassa)" required aria-label="Shop ID">
                <input id="secret-key" type="password" placeholder="Secret Key (YooKassa)" required aria-label="Secret Key">
                <button id="save-settings" type="button">Сохранить</button>
                <button id="back-to-main" type="button">Назад</button>
            </form>
            <h2>Последние донаты</h2>
            <table id="donations-table">
                <thead>
                    <tr>
                        <th>Время</th>
                        <th>Ник</th>
                        <th>Сумма (RUB)</th>
                        <th>Сообщение</th>
                    </tr>
                </thead>
                <tbody id="donations-table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Overlay Page -->
    <div id="overlay-page" class="page hidden" style="background: transparent;">
        <div id="donation-alert" class="overlay-alert hidden">
            <p id="overlay-nickname" style="font-size: 1.5rem; font-weight: bold;"></p>
            <p id="overlay-amount" style="font-size: 1.2rem;"></p>
            <p id="overlay-message" style="font-size: 0.9rem; margin-top: 0.75rem;"></p>
        </div>
    </div>

    <script>
        // State Management
        let settings = JSON.parse(localStorage.getItem('donation-settings')) || { shopId: '', secretKey: '' };
        let donations = JSON.parse(localStorage.getItem('donations')) || [];

        // DOM Elements
        const mainPage = document.getElementById('main-page');
        const adminPanel = document.getElementById('admin-panel');
        const overlayPage = document.getElementById('overlay-page');
        const donateBtn = document.getElementById('donate-btn');
        const nicknameInput = document.getElementById('nickname');
        const amountInput = document.getElementById('amount');
        const messageInput = document.getElementById('message');
        const shopIdInput = document.getElementById('shop-id');
        const secretKeyInput = document.getElementById('secret-key');
        const saveSettingsBtn = document.getElementById('save-settings');
        const backToMainBtn = document.getElementById('back-to-main');
        const donationAlert = document.getElementById('donation-alert');
        const overlayNickname = document.getElementById('overlay-nickname');
        const overlayAmount = document.getElementById('overlay-amount');
        const overlayMessage = document.getElementById('overlay-message');
        const donationsTableBody = document.getElementById('donations-table-body');

        // Check YooKassa SDK
        console.log('YooKassa SDK available:', typeof window.YooKassaCheckoutWidget !== 'undefined');

        // Update Donations Table
        function updateDonationsTable() {
            donationsTableBody.innerHTML = '';
            const recentDonations = donations.slice(-10).reverse(); // Last 10 donations
            recentDonations.forEach(donation => {
                const row = document.createElement('tr');
                const date = new Date(donation.timestamp).toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' });
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${donation.nickname}</td>
                    <td>${donation.amount.toFixed(2)}</td>
                    <td>${donation.message}</td>
                `;
                donationsTableBody.appendChild(row);
            });
            console.log('Donations table updated:', recentDonations);
        }

        // Enable/Disable Donate Button
        function updateDonateButton() {
            const hasSettings = settings.shopId && settings.secretKey;
            const hasInputs = nicknameInput.value.trim() && amountInput.value > 0 && messageInput.value.trim();
            console.log('Settings:', { shopId: settings.shopId, secretKey: settings.secretKey ? '[hidden]' : '' });
            console.log('Inputs:', {
                nickname: nicknameInput.value.trim(),
                amount: amountInput.value,
                message: messageInput.value.trim(),
                valid: hasInputs
            });
            donateBtn.disabled = !(hasSettings && hasInputs);
        }

        nicknameInput.addEventListener('input', updateDonateButton);
        amountInput.addEventListener('input', updateDonateButton);
        messageInput.addEventListener('input', updateDonateButton);

        // Initialize Settings and Donations
        shopIdInput.value = settings.shopId;
        secretKeyInput.value = settings.secretKey;
        console.log('Initial localStorage:', {
            settings: localStorage.getItem('donation-settings'),
            donations: localStorage.getItem('donations')
        });
        updateDonateButton();
        updateDonationsTable();

        // Save Settings
        saveSettingsBtn.addEventListener('click', () => {
            settings = { shopId: shopIdInput.value.trim(), secretKey: secretKeyInput.value.trim() };
            localStorage.setItem('donation-settings', JSON.stringify(settings));
            console.log('Settings saved:', { shopId: settings.shopId, secretKey: '[hidden]' });
            alert('Настройки сохранены!');
            updateDonateButton();
        });

        // Navigation
        backToMainBtn.addEventListener('click', () => {
            adminPanel.classList.add('hidden');
            mainPage.classList.remove('hidden');
            console.log('Navigated back to main page');
        });

        // Access Admin Panel
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'a') {
                const password = prompt('Введите пароль для админ-панели:');
                if (password === 'admin123') {
                    mainPage.classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                    updateDonationsTable();
                    console.log('Admin panel accessed');
                } else {
                    alert('Неверный пароль!');
                    console.log('Admin access denied: incorrect password');
                }
            }
        });

        // Donation Handler
        donateBtn.addEventListener('click', () => {
            console.log('Donate button clicked');
            const amount = parseFloat(amountInput.value);
            const nickname = nicknameInput.value.trim();
            const message = messageInput.value.trim();
            console.log('Donation data:', { nickname, amount, message });

            try {
                // Mock payment for testing (used since no server is available)
                const payment = { id: `mock-${Date.now()}` };
                const donation = { id: payment.id, nickname, amount, message, timestamp: Date.now(), shown: false };
                donations.push(donation);
                localStorage.setItem('donations', JSON.stringify(donations));
                console.log('Donation saved:', donation);
                console.log('Current donations:', donations);

                // Clear inputs
                nicknameInput.value = '';
                amountInput.value = '';
                messageInput.value = '';
                updateDonateButton();
                updateDonationsTable();
                console.log('Form cleared and donations table updated');

                alert('Платеж имитирован успешно! Донат отобразится в оверлее.');

                /* For real YooKassa integration:
                   - You need a server to create payment tokens, as GitHub Pages doesn't support server-side logic.
                   - Set up a backend (e.g., Node.js) on a free hosting service like Render or Railway.
                   - Example server code (save as server.js):
                     const express = require('express');
                     const fetch = require('node-fetch');
                     const app = express();
                     app.use(express.json());
                     app.use((req, res, next) => {
                         res.header('Access-Control-Allow-Origin', 'https://towuk.github.io');
                         res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');
                         next();
                     });
                     app.post('/create-payment', async (req, res) => {
                         try {
                             const { shopId, secretKey, amount, nickname, message } = req.body;
                             const response = await fetch('https://api.yookassa.ru/v3/payments', {
                                 method: 'POST',
                                 headers: {
                                     'Authorization': 'Basic ' + Buffer.from(`${shopId}:${secretKey}`).toString('base64'),
                                     'Content-Type': 'application/json',
                                     'Idempotency-Key': Math.random().toString(36).substring(2),
                                 },
                                 body: JSON.stringify({
                                     amount: { value: amount.toFixed(2), currency: 'RUB' },
                                     confirmation: { type: 'embedded' },
                                     capture: true,
                                     description: `${nickname}: ${message}`,
                                 }),
                             });
                             if (!response.ok) {
                                 const errorData = await response.json();
                                 throw new Error(errorData.description || 'Failed to create payment');
                             }
                             const data = await response.json();
                             res.json({ token: data.confirmation.confirmation_token });
                         } catch (error) {
                             res.status(500).json({ error: error.message });
                         }
                     });
                     app.listen(3000);
                   - Install dependencies: npm init -y; npm install express node-fetch
                   - Deploy to Render (https://render.com):
                     1. Create a new Web Service, connect your GitHub repo with server.js.
                     2. Set runtime to Node.js, start command: node server.js
                     3. Get the URL (e.g., https://your-app.onrender.com).
                   - Update the client code to use the server:
                     async function fetchPaymentToken(amount, nickname, message) {
                         const response = await fetch('https://your-app.onrender.com/create-payment', {
                             method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify({ shopId: settings.shopId, secretKey: settings.secretKey, amount, nickname, message }),
                         });
                         if (!response.ok) {
                             const errorData = await response.json();
                             throw new Error(errorData.error || 'Failed to create payment');
                         }
                         const { token } = await response.json();
                         return token;
                     }
                     if (typeof window.YooKassaCheckoutWidget === 'undefined') {
                         throw new Error('YooKassa SDK not loaded');
                     }
                     const checkout = new window.YooKassaCheckoutWidget({
                         shopId: settings.shopId,
                         token: await fetchPaymentToken(amount, nickname, message),
                     });
                     checkout.render('donate-btn');
                     checkout.on('success', (payment) => {
                         const donation = { id: payment.id, nickname, amount, message, timestamp: Date.now(), shown: false };
                         donations.push(donation);
                         localStorage.setItem('donations', JSON.stringify(donations));
                         console.log('Real donation saved:', donation);
                         nicknameInput.value = '';
                         amountInput.value = '';
                         messageInput.value = '';
                         updateDonateButton();
                         updateDonationsTable();
                         alert('Платеж успешен! Донат отобразится в оверлее.');
                     });
                     checkout.on('fail', (error) => {
                         console.error('YooKassa payment error:', error);
                         alert('Ошибка платежа: ' + error.message);
                     });
                   - Use test Shop ID and Secret Key from YooKassa dashboard: https://yookassa.ru/developers/using-api/testing
                */
            } catch (error) {
                console.error('Payment error:', error);
                alert('Ошибка при обработке доната: ' + error.message);
            }
        });

        // Overlay Logic
        function checkForNewDonations() {
            console.log('Checking for new donations:', donations.length);
            const lastDonation = donations[donations.length - 1];
            if (lastDonation && !lastDonation.shown) {
                console.log('Displaying donation:', lastDonation);
                overlayNickname.textContent = lastDonation.nickname;
                overlayAmount.textContent = `${lastDonation.amount.toFixed(2)} RUB`;
                overlayMessage.textContent = lastDonation.message;

                donationAlert.classList.remove('hidden');
                donationAlert.classList.add('fade-in');

                setTimeout(() => {
                    donationAlert.classList.remove('fade-in');
                    donationAlert.classList.add('fade-out');
                    setTimeout(() => {
                        donationAlert.classList.add('hidden');
                        donationAlert.classList.remove('fade-out');
                        lastDonation.shown = true;
                        localStorage.setItem('donations', JSON.stringify(donations));
                        console.log('Donation marked as shown:', lastDonation);
                    }, 1000);
                }, 15000);
            }
        }

        // Simulate Overlay Page Load
        if (window.location.hash === '#overlay') {
            mainPage.classList.add('hidden');
            adminPanel.classList.add('hidden');
            overlayPage.classList.remove('hidden');
            console.log('Overlay page loaded');
            setInterval(checkForNewDonations, 1000);
        }
    </script>
</body>
</html>
